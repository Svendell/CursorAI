# üóÇÔ∏è Manifest –∏ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ê–∫–∫–∞—É–Ω—Ç–æ–≤ SteamGuard

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ß—Ç–æ —Ç–∞–∫–æ–µ Manifest](#—á—Ç–æ-—Ç–∞–∫–æ–µ-manifest)
2. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Manifest —Ñ–∞–π–ª–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-manifest-—Ñ–∞–π–ª–∞)
3. [–†–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ mafiles](#—Ä–∞–±–æ—Ç–∞-—Å-–Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏-mafiles)
4. [–û–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è](#–æ–ø–µ—Ä–∞—Ü–∏–∏-–∏-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
5. [–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Manifest](#–∑–∞–≥—Ä—É–∑–∫–∞-–∏-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ-manifest)

---

## –ß—Ç–æ —Ç–∞–∫–æ–µ Manifest

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Manifest** - —ç—Ç–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–±–æ –≤—Å–µ—Ö mafiles –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ü–æ–¥–æ–±–Ω–æ –∫–∞—Ç–∞–ª–æ–≥—É - –æ–Ω –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω—É–∂–Ω—ã–µ mafiles –±–µ–∑ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤.

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

```
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏:
mafiles/
‚îú‚îÄ‚îÄ account1.maFile
‚îú‚îÄ‚îÄ account2.maFile
‚îú‚îÄ‚îÄ account3.maFile
‚îî‚îÄ‚îÄ manifest.json  ‚Üê Manifest —Ñ–∞–π–ª
```

**Manifest.json** –ø–æ–º–æ–≥–∞–µ—Ç:
1. –ë—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
2. –•—Ä–∞–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
3. –£–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Ä—è–¥–∫–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
4. –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
5. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –æ–±–ª–∞–∫–æ–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Manifest —Ñ–∞–π–ª–∞

### –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```json
{
  "accounts": [
    {
      "account_name": "account1",
      "filename": "account1.maFile",
      "timestamp": 1705330800,
      "last_used": 1705330900,
      "enabled": true
    },
    {
      "account_name": "account2",
      "filename": "account2.maFile",
      "timestamp": 1705331000,
      "last_used": 1705331100,
      "enabled": true
    }
  ],
  "version": 1,
  "created": 1705330800,
  "updated": 1705331100
}
```

### –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

```json
{
  "version": 1,
  "created_at": 1705330800,
  "updated_at": 1705331100,
  "total_accounts": 3,
  "encrypted": false,
  "encryption_key_hash": "",
  
  "accounts": [
    {
      "account_name": "myaccount",
      "filename": "myaccount.maFile",
      "steam_id": 76561198123456789,
      "display_name": "My Account",
      "created_at": 1705330800,
      "updated_at": 1705330900,
      "last_used": 1705330950,
      "last_code": "12345",
      "last_code_time": 1705330900,
      "enabled": true,
      "favorite": false,
      "notes": "Main account",
      "confirmations_enabled": true,
      "last_confirmations_check": 1705330905,
      "pending_confirmations": 2,
      "status": "healthy"  // healthy, warning, error, offline
    },
    {
      "account_name": "altaccount",
      "filename": "altaccount.maFile",
      "steam_id": 76561198987654321,
      "display_name": "Alt Account",
      "created_at": 1705331000,
      "updated_at": 1705331100,
      "last_used": 1705331050,
      "last_code": "67890",
      "last_code_time": 1705331000,
      "enabled": true,
      "favorite": true,
      "notes": "",
      "confirmations_enabled": true,
      "last_confirmations_check": 1705331005,
      "pending_confirmations": 0,
      "status": "healthy"
    }
  ],
  
  "settings": {
    "auto_refresh_interval": 30,
    "notifications_enabled": true,
    "clipboard_copy_enabled": true,
    "lock_timeout_minutes": 5
  }
}
```

### –ü–æ–ª—è –≤ Manifest

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|---------|
| `version` | int | –í–µ—Ä—Å–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ manifest (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) |
| `created_at` | int | Unix timestamp —Å–æ–∑–¥–∞–Ω–∏—è manifest |
| `updated_at` | int | Unix timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| `total_accounts` | int | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ |
| `encrypted` | bool | –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –ª–∏ manifest |
| `accounts` | array | –ú–∞—Å—Å–∏–≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ |

### –ü–æ–ª—è Account –≤ Manifest

| –ü–æ–ª–µ | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|-----------|---------|
| `account_name` | string | ‚úì | –ò–º—è Steam –∞–∫–∫–∞—É–Ω—Ç–∞ |
| `filename` | string | ‚úì | –ò–º—è mafile —Ñ–∞–π–ª–∞ |
| `steam_id` | int | ‚úó | 64-bit Steam ID |
| `created_at` | int | ‚úó | –ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω mafile |
| `updated_at` | int | ‚úó | –ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω |
| `last_used` | int | ‚úó | –ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è |
| `last_code` | string | ‚úó | –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ |
| `enabled` | bool | ‚úó | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –∞–∫–∫–∞—É–Ω—Ç |
| `favorite` | bool | ‚úó | –ò–∑–±—Ä–∞–Ω–Ω—ã–π –ª–∏ –∞–∫–∫–∞—É–Ω—Ç |
| `confirmations_enabled` | bool | ‚úó | –í–∫–ª—é—á–µ–Ω—ã –ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |
| `status` | string | ‚úó | –°—Ç–∞—Ç—É—Å (healthy, warning, error) |

---

## –†–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ mafiles

### –ö–ª–∞—Å—Å ManifestManager

```python
import json
import os
import time
from typing import List, Dict, Optional, Any

class ManifestManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ manifest —Ñ–∞–π–ª–æ–º"""
    
    def __init__(self, mafiles_dir: str):
        self.mafiles_dir = mafiles_dir
        self.manifest_path = os.path.join(mafiles_dir, 'manifest.json')
        self._ensure_manifest_exists()
    
    def _ensure_manifest_exists(self):
        """–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ manifest —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"""
        if not os.path.exists(self.manifest_path):
            self.create_empty_manifest()
    
    def create_empty_manifest(self):
        """–°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π manifest"""
        manifest = {
            'version': 1,
            'created_at': int(time.time()),
            'updated_at': int(time.time()),
            'total_accounts': 0,
            'encrypted': False,
            'encryption_key_hash': '',
            'accounts': [],
            'settings': {
                'auto_refresh_interval': 30,
                'notifications_enabled': True,
                'clipboard_copy_enabled': True,
                'lock_timeout_minutes': 5
            }
        }
        
        self._save_manifest(manifest)
    
    def load_manifest(self) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å manifest"""
        try:
            with open(self.manifest_path, 'r') as f:
                return json.load(f)
        except (json.JSONDecodeError, FileNotFoundError):
            self.create_empty_manifest()
            return self.load_manifest()
    
    def _save_manifest(self, manifest: Dict[str, Any]):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å manifest"""
        manifest['updated_at'] = int(time.time())
        manifest['total_accounts'] = len(manifest.get('accounts', []))
        
        with open(self.manifest_path, 'w') as f:
            json.dump(manifest, f, indent=2)
    
    def add_account_to_manifest(self, account_name: str, filename: str,
                               steam_id: Optional[int] = None) -> bool:
        """–î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –≤ manifest"""
        manifest = self.load_manifest()
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
        if any(acc['account_name'] == account_name for acc in manifest['accounts']):
            return False
        
        # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
        account_entry = {
            'account_name': account_name,
            'filename': filename,
            'steam_id': steam_id,
            'created_at': int(time.time()),
            'updated_at': int(time.time()),
            'last_used': None,
            'last_code': '',
            'last_code_time': None,
            'enabled': True,
            'favorite': False,
            'notes': '',
            'confirmations_enabled': True,
            'last_confirmations_check': None,
            'pending_confirmations': 0,
            'status': 'healthy'
        }
        
        manifest['accounts'].append(account_entry)
        self._save_manifest(manifest)
        
        return True
    
    def remove_account_from_manifest(self, account_name: str) -> bool:
        """–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∏–∑ manifest"""
        manifest = self.load_manifest()
        
        original_count = len(manifest['accounts'])
        manifest['accounts'] = [
            acc for acc in manifest['accounts']
            if acc['account_name'] != account_name
        ]
        
        if len(manifest['accounts']) < original_count:
            self._save_manifest(manifest)
            return True
        
        return False
    
    def update_account_in_manifest(self, account_name: str,
                                  updates: Dict[str, Any]) -> bool:
        """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ manifest"""
        manifest = self.load_manifest()
        
        for account in manifest['accounts']:
            if account['account_name'] == account_name:
                account.update(updates)
                account['updated_at'] = int(time.time())
                self._save_manifest(manifest)
                return True
        
        return False
    
    def get_all_accounts(self) -> List[Dict[str, Any]]:
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑ manifest"""
        manifest = self.load_manifest()
        return manifest.get('accounts', [])
    
    def get_account(self, account_name: str) -> Optional[Dict[str, Any]]:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç"""
        manifest = self.load_manifest()
        
        for account in manifest['accounts']:
            if account['account_name'] == account_name:
                return account
        
        return None
    
    def update_last_used(self, account_name: str):
        """–û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
        self.update_account_in_manifest(
            account_name,
            {'last_used': int(time.time())}
        )
    
    def update_last_code(self, account_name: str, code: str):
        """–û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥"""
        self.update_account_in_manifest(
            account_name,
            {
                'last_code': code,
                'last_code_time': int(time.time())
            }
        )
    
    def set_favorite(self, account_name: str, is_favorite: bool) -> bool:
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—Å–Ω—è—Ç—å —Ñ–ª–∞–≥ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ"""
        return self.update_account_in_manifest(
            account_name,
            {'favorite': is_favorite}
        )
    
    def sync_with_filesystem(self) -> List[str]:
        """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å manifest —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π"""
        manifest = self.load_manifest()
        
        # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ .maFile —Ñ–∞–π–ª—ã
        existing_files = {
            f[:-7] for f in os.listdir(self.mafiles_dir)
            if f.endswith('.maFile')
        }
        
        # –ü–æ–ª—É—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑ manifest
        manifest_accounts = {acc['account_name'] for acc in manifest['accounts']}
        
        # –ù–∞–π—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
        missing_files = manifest_accounts - existing_files
        
        # –£–¥–∞–ª–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–∑ manifest
        for account_name in missing_files:
            self.remove_account_from_manifest(account_name)
        
        # –ù–∞–π—Ç–∏ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        new_files = existing_files - manifest_accounts
        
        # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –≤ manifest
        for account_name in new_files:
            filename = f"{account_name}.maFile"
            self.add_account_to_manifest(account_name, filename)
        
        return missing_files
```

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ManifestManager

```python
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
manifest_mgr = ManifestManager('mafiles')

# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
manifest_mgr.add_account_to_manifest(
    account_name='myaccount',
    filename='myaccount.maFile',
    steam_id=76561198123456789
)

# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã
accounts = manifest_mgr.get_all_accounts()
print(f"–í—Å–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: {len(accounts)}")

# –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
manifest_mgr.update_last_used('myaccount')
manifest_mgr.update_last_code('myaccount', '12345')

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
manifest_mgr.set_favorite('myaccount', True)

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
missing = manifest_mgr.sync_with_filesystem()
if missing:
    print(f"–£–¥–∞–ª–µ–Ω–Ω—ã–µ –º–∞files: {missing}")

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
account = manifest_mgr.get_account('myaccount')
print(f"–°—Ç–∞—Ç—É—Å: {account['status']}")
print(f"–û–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: {account['pending_confirmations']}")
```

---

## –û–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### –¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π (Confirmation Types)

```python
class ConfirmationType:
    """–¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    
    TRADE = 2          # –¢–æ—Ä–≥–æ–≤–ª—è (trade offer)
    MARKET = 3         # –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å (community market)
    LISTING = 6        # –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ª–æ—Ç–∞
    ACCOUNT = 7        # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º
    PROFILE_CHANGE = 11 # –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Operation

```python
@dataclass
class ConfirmationOperation:
    """–û–ø–µ—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    
    # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
    confirmation_id: str              # ID –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    confirmation_key: str             # –ö–ª—é—á –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    operation_type: int               # –¢–∏–ø (2=trade, 3=market –∏ —Ç.–¥.)
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    timestamp: int                    # Unix timestamp
    received_at: int                  # –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ü–∏–∏
    other_account_name: Optional[str] # –ò–º—è –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    other_steam_id: Optional[int]    # Steam ID –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    item_description: str             # –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞/–æ–ø–µ—Ä–∞—Ü–∏–∏
    
    # –°—Ç–∞—Ç—É—Å
    status: str                       # pending, confirmed, declined, expired
    expires_at: int                   # –ö–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç
```

### –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è–º–∏

```python
import requests
from datetime import datetime, timedelta

class ConfirmationManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è–º–∏"""
    
    BASE_URL = 'https://steamcommunity.com/mobileconf'
    
    def __init__(self, account: Dict[str, Any]):
        self.account = account
        self.identity_secret = account['identity_secret']
        self.steam_id = account.get('steam_id')
    
    def _get_confirmations_url(self, tag: str = 'conf') -> str:
        """–°–æ–∑–¥–∞—Ç—å URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π"""
        server_time = int(time.time())
        
        # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö–µ—à
        from app.steam_utils import SteamAPIAuth
        conf_hash = SteamAPIAuth.generate_confirmation_hash(
            self.identity_secret, tag
        )
        
        url = (
            f'{self.BASE_URL}/getlist'
            f'?p=0'
            f'&a={self.steam_id}'
            f'&k={conf_hash}'
            f'&t={server_time}'
            f'&m=react'
            f'&tag={tag}'
        )
        
        return url
    
    def fetch_confirmations(self) -> List[ConfirmationOperation]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π"""
        try:
            url = self._get_confirmations_url('conf')
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
                'Accept': 'application/json'
            }
            
            response = requests.get(url, headers=headers, timeout=10)
            response.raise_for_status()
            
            data = response.json()
            
            confirmations = []
            for conf in data.get('confirmations', []):
                operation = ConfirmationOperation(
                    confirmation_id=conf['id'],
                    confirmation_key=conf['key'],
                    operation_type=int(conf['type']),
                    timestamp=int(conf['creation_time']),
                    received_at=int(time.time()),
                    other_account_name=conf.get('creator_name', ''),
                    other_steam_id=conf.get('creator', None),
                    item_description=conf.get('multi', [{}])[0].get(
                        'description', ''
                    ) if conf.get('multi') else '',
                    status='pending',
                    expires_at=int(conf['creation_time']) + 86400 * 15
                )
                
                confirmations.append(operation)
            
            return confirmations
        
        except Exception as e:
            logger.error(f"Failed to fetch confirmations: {e}")
            return []
    
    def confirm_operation(self, confirmation_id: str,
                         confirmation_key: str) -> bool:
        """–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é"""
        try:
            server_time = int(time.time())
            
            from app.steam_utils import SteamAPIAuth
            allow_hash = SteamAPIAuth.generate_confirmation_hash(
                self.identity_secret, 'allow'
            )
            
            url = (
                f'{self.BASE_URL}/ajaxop'
                f'?op=allow'
                f'&p=0'
                f'&a={self.steam_id}'
                f'&k={allow_hash}'
                f'&t={server_time}'
                f'&m=react'
                f'&tag=allow'
            )
            
            data = {
                'confid': confirmation_id,
                'key': confirmation_key,
                'op': 'allow'
            }
            
            response = requests.post(url, data=data, timeout=10)
            return response.status_code == 200
        
        except Exception as e:
            logger.error(f"Failed to confirm: {e}")
            return False
    
    def cancel_operation(self, confirmation_id: str,
                        confirmation_key: str) -> bool:
        """–û—Ç–∫–ª–æ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é"""
        try:
            server_time = int(time.time())
            
            from app.steam_utils import SteamAPIAuth
            cancel_hash = SteamAPIAuth.generate_confirmation_hash(
                self.identity_secret, 'cancel'
            )
            
            url = (
                f'{self.BASE_URL}/ajaxop'
                f'?op=cancel'
                f'?p=0'
                f'&a={self.steam_id}'
                f'&k={cancel_hash}'
                f'&t={server_time}'
                f'&m=react'
                f'&tag=cancel'
            )
            
            data = {
                'confid': confirmation_id,
                'key': confirmation_key,
                'op': 'cancel'
            }
            
            response = requests.post(url, data=data, timeout=10)
            return response.status_code == 200
        
        except Exception as e:
            logger.error(f"Failed to cancel: {e}")
            return False
```

---

## –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Manifest

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Manifest

```python
def save_manifest(manifest: Dict, path: str):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å manifest —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    
    # –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    required_fields = ['version', 'created_at', 'updated_at', 'accounts']
    for field in required_fields:
        if field not in manifest:
            raise ValueError(f"Missing required field: {field}")
    
    # –û–±–Ω–æ–≤–∏—Ç—å timestamp
    manifest['updated_at'] = int(time.time())
    manifest['total_accounts'] = len(manifest['accounts'])
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
    with open(path, 'w') as f:
        json.dump(manifest, f, indent=2)
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    os.chmod(path, 0o600)  # rw------- —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
```

### –ó–∞–≥—Ä—É–∑–∫–∞ Manifest

```python
def load_manifest(path: str) -> Dict:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å manifest —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    
    try:
        with open(path, 'r') as f:
            manifest = json.load(f)
        
        # –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é
        if manifest.get('version', 1) != 1:
            raise ValueError("Unsupported manifest version")
        
        # –£–±–µ–¥–∏—Ç—å—Å—è –≤ –Ω–∞–ª–∏—á–∏–∏ accounts
        if 'accounts' not in manifest:
            manifest['accounts'] = []
        
        return manifest
    
    except FileNotFoundError:
        # –í–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π manifest
        return {
            'version': 1,
            'created_at': int(time.time()),
            'updated_at': int(time.time()),
            'total_accounts': 0,
            'accounts': []
        }
```

---

## üìå –†–µ–∑—é–º–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|-----------|
| **Manifest** | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö mafiles |
| **Account Entry** | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–¥–Ω–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ |
| **ConfirmationManager** | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è–º–∏ |
| **ConfirmationOperation** | –û–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |
| **ManifestManager** | API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å manifest |

