# ๐ฏ ะะตะทัะผะต - ะกัััะบัััะฐ SteamGuard Mafile

## ะะฑะทะพั

ะะฐ ะพัะฝะพะฒะต ะธััะปะตะดะพะฒะฐะฝะธั ะธััะพะดะฝะพะณะพ ะบะพะดะฐ ะฒะฐัะตะณะพ ะฟัะพะตะบัะฐ ะธ ะทะฝะฐะฝะธะน ะพ SteamGuard, ั ัะพะทะดะฐะป ะฟะพะปะฝัั ะดะพะบัะผะตะฝัะฐัะธั ั **5 ะฟะพะดัะพะฑะฝัะผะธ ะดะพะบัะผะตะฝัะฐะผะธ**. ะะพั ะบัะฐัะบะพะต ัะตะทัะผะต ะบะปััะตะฒะพะน ะธะฝัะพัะผะฐัะธะธ:

---

## ๐ ะะปััะตะฒะฐั ะธะฝัะพัะผะฐัะธั ะพ Mafile

### ะะธะฝะธะผะฐะปัะฝะฐั ััััะบัััะฐ (ัะฐะฑะพัะฐััะฐั)

```json
{
  "shared_secret": "FhkMQfG2w3Z9nBvK7xL2mN4pQ6rS8tU1wV2xY3zA=",
  "account_name": "mysteamaccount"
}
```

**ะะผะตะฝะฝะพ ััะพะณะพ ะดะพััะฐัะพัะฝะพ ะดะปั ะณะตะฝะตัะธัะพะฒะฐะฝะธั 2FA ะบะพะดะพะฒ!**

### ะะพะปะฝะฐั ััััะบัััะฐ (ั ะฟะพะดัะฒะตัะถะดะตะฝะธัะผะธ)

```json
{
  "shared_secret": "FhkMQfG2w3Z9nBvK7xL2mN4pQ6rS8tU1wV2xY3zA=",
  "identity_secret": "aBcDeFgHiJkLmNoPqRsTuVwXyZ1A2B3C4D5E6F7G=",
  "revocation_code": "A1B2C-D3E4F-G5H6I",
  "account_name": "mysteamaccount",
  "uri": "",
  "server_time": 1705330800,
  "account_name_hmac": "",
  "session_id": "",
  "fully_enrolled": true
}
```

---

## ๐ ะะฑัะทะฐัะตะปัะฝัะต ะฟะพะปั

| ะะพะปะต | ะคะพัะผะฐั | ะะฐะทะผะตั | ะะฐะทะฝะฐัะตะฝะธะต |
|------|--------|--------|-----------|
| `shared_secret` | Base64 | 28 ัะธะผะฒะพะปะพะฒ | ะะตะฝะตัะธัะพะฒะฐะฝะธะต 2FA ะบะพะดะพะฒ |
| `account_name` | String | 3-32 ัะธะผะฒะพะปะฐ | ะะดะตะฝัะธัะธะบะฐัะพั ะฐะบะบะฐัะฝัะฐ |

## ๐ ะะฟัะธะพะฝะฐะปัะฝัะต ะฟะพะปั

| ะะพะปะต | ะคะพัะผะฐั | ะะฐะทะฝะฐัะตะฝะธะต |
|------|--------|-----------|
| `identity_secret` | Base64 | ะะพะดัะฒะตัะถะดะตะฝะธะต ะพะฟะตัะฐัะธะน (ัะพัะณะพะฒะปั, ะผะฐัะบะตัะฟะปะตะนั) |
| `revocation_code` | XXXXX-XXXXX-XXXXX | ะะตะทะตัะฒะฝัะน ะพัะบะปััะตะฝะธะต 2FA |
| `uri` | String | ะะดะตะฝัะธัะธะบะฐัะพั ัะธะฟะฐ (ะพะฑััะฝะพ ะฟัััะพ) |
| `server_time` | Unix timestamp | ะะพะณะดะฐ ัะพััะฐะฝะตะฝ mafile |
| `account_name_hmac` | Base64 | ะัะพะฒะตัะบะฐ ัะตะปะพััะฝะพััะธ ะธะผะตะฝะธ |
| `session_id` | String | ID ัะตััะธะธ ะผะพะฑะธะปัะฝะพะณะพ ะฟัะธะปะพะถะตะฝะธั |
| `fully_enrolled` | Boolean | ะคะปะฐะณ ะฟะพะปะฝะพะน ัะตะณะธัััะฐัะธะธ |

---

## ๐งฌ ะะตะฝะตัะธัะพะฒะฐะฝะธะต Secrets

### shared_secret (ะดะปั 2FA ะบะพะดะพะฒ)

```python
import os
import base64

# ะะตะฝะตัะธัะพะฒะฐะฝะธะต (20 ะฑะฐะนั)
secret_bytes = os.urandom(20)
shared_secret = base64.b64encode(secret_bytes).decode('utf-8')

# ะะตะทัะปััะฐั: 28 ัะธะผะฒะพะปะพะฒ Base64
# ะัะธะผะตั: sM3/3L0pXvfXhY2ZvB7cK9mN4pQ6rS8tU1wV2xY3zA=
```

### identity_secret (ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธะน)

```python
# ะะตะฝะตัะธัะพะฒะฐะฝะธะต (20 ะฑะฐะนั)
secret_bytes = os.urandom(20)
identity_secret = base64.b64encode(secret_bytes).decode('utf-8')

# ะะตะทัะปััะฐั: 28 ัะธะผะฒะพะปะพะฒ Base64
# ะัะธะผะตั: aBcDeFgHiJkLmNoPqRsTuVwXyZ1A2B3C4D5E6F7G=
```

### revocation_code (ัะตะทะตัะฒะฝัะน)

```python
import random
import string

chars = string.ascii_uppercase + string.digits
code = '-'.join(
    ''.join(random.choice(chars) for _ in range(5))
    for _ in range(3)
)

# ะคะพัะผะฐั: XXXXX-XXXXX-XXXXX
# ะัะธะผะตั: A1B2C-D3E4F-G5H6I
```

---

## ๐ ะัะฝะพะฒะฝัะต ะฐะปะณะพัะธัะผั

### TOTP (Time-based One-Time Password) - ะะตะฝะตัะธัะพะฒะฐะฝะธะต 2FA ะบะพะดะฐ

**ะัะพะด:** shared_secret (Base64)  
**ะััะพะด:** 5-ะทะฝะฐัะฝัะน ะบะพะด

```
ะญัะฐะฟั:
1. secret_bytes = base64_decode(shared_secret)
2. time_counter = current_time // 30  (30-ัะตะบ ะฟะตัะธะพะดั)
3. time_bytes = big_endian_8_bytes(time_counter)
4. hmac_hash = HMAC-SHA1(secret_bytes, time_bytes)
5. index = hmac_hash[-1] & 0x0f
6. code = (hmac_hash[index:index+4] % 100000).zfill(5)
```

**ะะปััะตะฒัะต ะผะพะผะตะฝัั:**
- โ ะัะฟะพะปัะทัะตััั **big-endian** (`>Q` ะฒ struct.pack)
- โ ะัะฟะพะปัะทัะตััั **HMAC-SHA1** (ะฝะต MD5, ะฝะต SHA256)
- โ ะะตัะธะพะด **30 ัะตะบัะฝะด** (ะบะพะด ะผะตะฝัะตััั ะบะฐะถะดัะต 30 ัะตะบ)
- โ ะะตะทัะปััะฐั **5 ัะธัั** (ะฒัะตะณะดะฐ ะดะพะฟะพะปะฝัะตััั ะฝัะปัะผะธ)

### Confirmation Hash - ะะพะดัะฒะตัะถะดะตะฝะธะต ะพะฟะตัะฐัะธะน

**ะัะพะด:** identity_secret (Base64), tag ('conf'/'details'/'allow'/'cancel')  
**ะััะพะด:** Base64 ัะตั

```
ะญัะฐะฟั:
1. secret_bytes = base64_decode(identity_secret)
2. time_counter = current_time // 30
3. time_bytes = big_endian_8_bytes(time_counter)
4. tag_bytes = tag.encode('utf-8')
5. data = time_bytes + tag_bytes
6. hmac_hash = HMAC-SHA1(secret_bytes, data)
7. hash = base64_encode(hmac_hash)
```

**ะขะตะณะธ:**
- `'conf'` - ะฟะพะปััะธัั ัะฟะธัะพะบ ะฟะพะดัะฒะตัะถะดะตะฝะธะน
- `'details'` - ะฟะพะปััะธัั ะดะตัะฐะปะธ ะฟะพะดัะฒะตัะถะดะตะฝะธั
- `'allow'` - ะฟะพะดัะฒะตัะดะธัั ะพะฟะตัะฐัะธั
- `'cancel'` - ะพัะบะปะพะฝะธัั ะพะฟะตัะฐัะธั

---

## ๐ ะะปะฐััั ะฒ ะบะพะดะต

### SteamGuardManager - ะฃะฟัะฐะฒะปะตะฝะธะต mafiles

```python
manager = SteamGuardManager()

# ะกะพะทะดะฐัั ะธ ัะพััะฐะฝะธัั
manager.create_mafile_from_dict({
    'shared_secret': secret,
    'account_name': 'myaccount',
    'identity_secret': identity_secret,
    'revocation_code': code
})

# ะะผะฟะพััะธัะพะฒะฐัั
data = manager.import_mafile('mafiles/myaccount.maFile')

# ะะพะปััะธัั ะบะพะด
code = manager.get_steam_guard_code(shared_secret)
```

### SteamGuardUtil - ะฃัะธะปะธัั TOTP

```python
from app.steam_utils import SteamGuardUtil

# ะะตะฝะตัะธัะพะฒะฐัั ะบะพะด
code = SteamGuardUtil.generate_steam_guard_code(shared_secret)

# ะััะฐัะพะบ ะฒัะตะผะตะฝะธ
remaining = SteamGuardUtil.get_code_time_remaining()
```

### MafileValidator - ะะฐะปะธะดะฐัะธั

```python
from app.steam_utils import MafileValidator

# ะะฐะปะธะดะธัะพะฒะฐัั ััััะบัััั
is_valid = MafileValidator.validate_mafile(mafile_data)

# ะัะพะฒะตััะตะผัะต ะฟะพะปั:
# - ะะฑัะทะฐัะตะปัะฝัะต: shared_secret, account_name
# - Base64: shared_secret, identity_secret
```

### SteamAPIAuth - ะะฐะฑะพัะฐ ั API

```python
from app.steam_utils import SteamAPIAuth

# ะะตะฝะตัะธัะพะฒะฐัั ัะตั ะฟะพะดัะฒะตัะถะดะตะฝะธั
hash = SteamAPIAuth.generate_confirmation_hash(
    identity_secret,
    tag='conf'
)

# ะกะพะทะดะฐัั URL ะดะปั ะทะฐะฟัะพัะฐ
url = SteamAPIAuth.get_confirmations_url(
    steam_id,
    identity_secret,
    access_token
)
```

---

## ๐ ะกัััะบัััะฐ mafiles ะฟะฐะฟะบะธ

```
mafiles/
โโโ account1.maFile          # JSON ัะฐะนะป
โโโ account2.maFile          # JSON ัะฐะนะป
โโโ manifest.json            # ะะตัะฐะดะฐะฝะฝัะต (ะพะฟัะธะพะฝะฐะปัะฝะพ)
```

**ะะผั ัะฐะนะปะฐ:** `{account_name}.maFile`

---

## ๐ ะัะพัะตัั ัะพะทะดะฐะฝะธั Mafile

### ะะฐัะธะฐะฝั 1: ะั Steam (ัะตะฐะปัะฝัะน)

```
1. ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ะปะพะณะธะฝ/ะฟะฐัะพะปั
   โ
2. Steam ะฐะฒัะพัะธะทัะตั ะธ ะฒะพะทะฒัะฐัะฐะตั secrets
   โ
3. ะัะธะปะพะถะตะฝะธะต ัะพะทะดะฐะตั mafile ั secrets ะพั Steam
   โ
4. Mafile ัะฐะฑะพัะฐะตั ััะฐะทั
```

### ะะฐัะธะฐะฝั 2: ะะท ัััะตััะฒัััะตะณะพ (ะธะผะฟะพัั)

```
1. ะะพะปัะทะพะฒะฐัะตะปั ะฟัะตะดะพััะฐะฒะปัะตั ัะฐะนะป mafile
   โ
2. ะัะธะปะพะถะตะฝะธะต ะฒะฐะปะธะดะธััะตั ััััะบัััั
   โ
3. ะัะธะปะพะถะตะฝะธะต ะธะผะฟะพััะธััะตั ะฒ ะะ
   โ
4. Mafile ะณะพัะพะฒ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั
```

### ะะฐัะธะฐะฝั 3: ะะตะผะพ (ัะตะบััะฐั ัะตะฐะปะธะทะฐัะธั)

```
1. ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ะปะพะณะธะฝ/ะฟะฐัะพะปั
   โ
2. ะัะธะปะพะถะตะฝะธะต ะณะตะฝะตัะธััะตั random secrets (ะะะะ!)
   โ
3. ะกะพะทะดะฐะตััั mafile ั ัะปััะฐะนะฝัะผะธ ัะตะบัะตัะฐะผะธ
   โ
4. ะะพะดั ะณะตะฝะตัะธัััััั, ะฝะพ ััะพ ะฝะต ัะตะฐะปัะฝัะต ะบะพะดั Steam
```

---

## ๐ก๏ธ ะัะธัะธัะฝัะต ะฐัะฟะตะบัั ะฑะตะทะพะฟะฐัะฝะพััะธ

### โ ะะะะะะะ ะฝะต ะดะตะปะฐะนัะต

```python
# ะะพะณะธัะพะฒะฐะฝะธะต ะฟะพะปะฝะพะณะพ secret
print(f"Secret: {shared_secret}")

# ะฅัะฐะฝะตะฝะธะต ะฒ plaintext
with open('secrets.txt', 'w') as f:
    f.write(shared_secret)

# ะะตัะตะดะฐัะฐ ะฒ URL ะฟะฐัะฐะผะตััะฐั
requests.get(f"?secret={secret}")

# ะะพะฟะธัะพะฒะฐะฝะธะต ะฒ ะฟะฐะผััะธ
secret_copy = secret_var
```

### โ ะะกะะะะ ะดะตะปะฐะนัะต

```python
# ะจะธัััะนัะต secrets
encrypted = encrypt_secret(shared_secret)

# ะะพะณะธััะนัะต ั ะผะฐัะบะพะน
logger.info(f"Secret: {secret[:8]}...")

# ะะตัะตะดะฐะฒะฐะนัะต ะฒ ัะตะปะต POST ัะตัะตะท HTTPS
requests.post(url, json={'secret': secret})

# ะัะธัะฐะนัะต ะฟะฐะผััั
del secret_var
gc.collect()
```

---

## ๐ ะะฝัะตะณัะฐัะธั ั ะะ

### ะขะฐะฑะปะธัะฐ accounts

```sql
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY,
    account_name TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    shared_secret TEXT NOT NULL,        -- ะะฐัะธััะพะฒะฐะฝ!
    identity_secret TEXT,                -- ะะฐัะธััะพะฒะฐะฝ!
    revocation_code TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
)
```

**ะะฐะถะฝะพ:** ะัะต secrets ะดะพะปะถะฝั ะฑััั **ะทะฐัะธััะพะฒะฐะฝั** ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ ะฒ ะะ!

---

## ๐ ะกะฒัะทั ะผะตะถะดั ะบะพะผะฟะพะฝะตะฝัะฐะผะธ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ       ะะพะปัะทะพะฒะฐัะตะปั/ะัะธะปะพะถะตะฝะธะต      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      SteamAuthenticator             โ
โ  - login()                          โ
โ  - confirm_code()                   โ
โ  - _generate_secrets()              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ    SteamGuardManager                โ
โ  - create_mafile_from_dict()        โ
โ  - import_mafile()                  โ
โ  - get_steam_guard_code()           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ    SteamGuardUtil + Validators      โ
โ  - generate_steam_guard_code()      โ
โ  - validate_mafile()                โ
โ  - generate_confirmation_hash()     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
        โโโโโโโโโโโฌโโโโโโโโโโ
        โ         โ
    [maFile]   [Database]
   (JSON)      (SQLite)
```

---

## ๐ ะงะตะบ-ะปะธัั ะดะปั ัะตะฐะปะธะทะฐัะธะธ

### ะะฐะทะพะฒะฐั ััะฝะบัะธะพะฝะฐะปัะฝะพััั
- [x] ะกะพะทะดะฐะฝะธะต mafile ั shared_secret ะธ account_name
- [x] ะะผะฟะพัั ัััะตััะฒัััะตะณะพ mafile
- [x] ะะฐะปะธะดะฐัะธั ััััะบัััั mafile
- [x] ะะตะฝะตัะธัะพะฒะฐะฝะธะต 2FA ะบะพะดะพะฒ (TOTP)
- [x] ะกะพััะฐะฝะตะฝะธะต ะฒ mafiles ะฟะฐะฟะบั
- [x] ะกะพััะฐะฝะตะฝะธะต ะฒ ะะ

### ะะพะดัะฒะตัะถะดะตะฝะธั ะพะฟะตัะฐัะธะน
- [ ] ะะพะฑะฐะฒะธัั identity_secret ะฟัะธ ัะพะทะดะฐะฝะธะธ
- [ ] ะะตะฝะตัะธัะพะฒะฐัั confirmation hash
- [ ] ะะฐะฟัะพัะธัั ัะฟะธัะพะบ ะฟะพะดัะฒะตัะถะดะตะฝะธะน ั Steam API
- [ ] ะะพะดัะฒะตัะดะธัั ะพะฟะตัะฐัะธั ัะตัะตะท API
- [ ] ะัะบะปะพะฝะธัั ะพะฟะตัะฐัะธั ัะตัะตะท API

### ะัะพะดะฒะธะฝัััะต ััะฝะบัะธะธ
- [ ] ะกะธะฝััะพะฝะธะทะธัะพะฒะฐัั manifest ั ะผะฐfiles
- [ ] ะััะธัะพะฒะฐัั TOTP ะบะพะดั (ะฝะต ะฟะตัะตััะธััะฒะฐัั 30 ัะตะบ)
- [ ] ะะฐัะธัะฐ ะพั ะฑััััะพััะฐ
- [ ] ะจะธััะพะฒะฐะฝะธะต secrets ะฒ ะะ
- [ ] ะะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต mafiles
- [ ] ะญะบัะฟะพัั/ะธะผะฟะพัั manifest

---

## ๐ ะกะฟัะฐะฒะพัะฝัะต ะดะพะบัะผะตะฝัั

ะฏ ัะพะทะดะฐะป **5 ะฟะพะดัะพะฑะฝัั ะดะพะบัะผะตะฝัะพะฒ** ั ะฟะพะปะฝะพะน ะธะฝัะพัะผะฐัะธะตะน:

1. **[STEAMGUARD_QUICK_REFERENCE.md](STEAMGUARD_QUICK_REFERENCE.md)** - ะจะฟะฐัะณะฐะปะบะฐ (4 KB, 5 ะผะธะฝ)
2. **[MAFILE_STRUCTURE_GUIDE.md](MAFILE_STRUCTURE_GUIDE.md)** - ะะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ (25 KB, 30 ะผะธะฝ)
3. **[MAFILE_EXAMPLES_AND_TESTS.md](MAFILE_EXAMPLES_AND_TESTS.md)** - ะัะธะผะตัั ะธ ัะตััั (18 KB, 25 ะผะธะฝ)
4. **[MANIFEST_AND_OPERATIONS.md](MANIFEST_AND_OPERATIONS.md)** - Manifest ะธ ะฟะพะดัะฒะตัะถะดะตะฝะธั (20 KB, 25 ะผะธะฝ)
5. **[STEAMGUARD_BEST_PRACTICES.md](STEAMGUARD_BEST_PRACTICES.md)** - ะะตะทะพะฟะฐัะฝะพััั (22 KB, 30 ะผะธะฝ)
6. **[STEAMGUARD_DOCUMENTATION_INDEX.md](STEAMGUARD_DOCUMENTATION_INDEX.md)** - ะะฝะดะตะบั ะฒัะตั ะดะพะบัะผะตะฝัะพะฒ

---

## โ ะะพัะพะฒะพ!

ะขะตะฟะตัั ั ะฒะฐั ะตััั:

โ ะะพะปะฝะพะต ะฟะพะฝะธะผะฐะฝะธะต ััััะบัััั mafile  
โ ะะฟะธัะฐะฝะธะต ะฒัะตั ะพะฑัะทะฐัะตะปัะฝัั ะธ ะพะฟัะธะพะฝะฐะปัะฝัั ะฟะพะปะตะน  
โ ะะปะณะพัะธัะผั ะณะตะฝะตัะธัะพะฒะฐะฝะธั secrets ะธ ะบะพะดะพะฒ  
โ ะัะธะผะตัั ะบะพะดะฐ ะธ ัะตััั  
โ ะัััะธะต ะฟัะฐะบัะธะบะธ ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะฑะตะทะพะฟะฐัะฝะพััะธ  
โ ะะฝัะพัะผะฐัะธั ะพ ัะฐะฑะพัะต ั ะฝะตัะบะพะปัะบะธะผะธ ะฐะบะบะฐัะฝัะฐะผะธ  
โ ะัะธะผะตัั ะฟะพะดัะฒะตัะถะดะตะฝะธั ะพะฟะตัะฐัะธะน  

ะัะต ะดะพะบัะผะตะฝัั ะฝะฐัะพะดัััั ะฒ ะฟะฐะฟะบะต `/workspaces/CursorAI/` ะธ ะณะพัะพะฒั ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!

