# üîê SteamGuard –†–µ–∞–ª–∏–∑–∞—Ü–∏—è - –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π](#—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π)
2. [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)
3. [–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏](#—Ç–∏–ø–∏—á–Ω—ã–µ-–æ—à–∏–±–∫–∏)
4. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
5. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è](#–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è 1: –ë–∞–∑–æ–≤–∞—è (–ù–∞—à–∞ —Ç–µ–∫—É—â–∞—è)

```python
# ‚úì –ü–ª—é—Å—ã
- –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- –õ–µ–≥–∫–æ –ø–æ–Ω—è—Ç—å –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
- –†–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç mafiles

# ‚úó –ú–∏–Ω—É—Å—ã
- –ù–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Steam
- –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ù–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API Steam
- Secrets –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ (–Ω–µ –æ—Ç Steam)
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è 2: –ü–æ–ª–Ω–∞—è (–ö–∞–∫ –≤ SDA)

–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ:

```python
# –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. –†–µ–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Steam
   - –ó–∞–ø—Ä–æ—Å—ã –∫ steamcommunity.com
   - –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ RSA —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫

2. –ü–æ–ª—É—á–µ–Ω–∏–µ secrets –æ—Ç Steam
   - shared_secret –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - identity_secret –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

3. –†–∞–±–æ—Ç–∞ —Å Steam API
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Å—Å–∏–π

4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
   - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ó–∞—â–∏—Ç–∞ –æ—Ç MITM –∞—Ç–∞–∫
   - SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è 3: Production-ready

```python
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - Retry –ª–æ–≥–∏–∫–∞
   - Graceful degradation
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ö—ç—à –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
   - –ö—ç—à —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
   - TTL —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   - –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - Tracking –æ—à–∏–±–æ–∫
   - Performance –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - Unit —Ç–µ—Å—Ç—ã
   - Integration —Ç–µ—Å—Ç—ã
   - –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ Steam API
```

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –†–∞–±–æ—Ç–∞ —Å Secrets

#### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û

```python
# –•—Ä–∞–Ω–∏—Ç—å –≤ plaintext
shared_secret = "sM3/3L0pXvfXhY2ZvB7cK9mN4pQ6rS8tU1wV2xY3zA="

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π secret
print(f"Secret: {shared_secret}")

# –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö URL
url = f"?secret={shared_secret}"

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–∞–º—è—Ç–∏
secret_copy = shared_secret  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω
```

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

```python
# –®–∏—Ñ—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
from app.encryption import encrypt_secret

encrypted_secret = encrypt_secret(shared_secret)
db.save(encrypted_secret)

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å –º–∞—Å–∫–æ–π
logger.info(f"Secret: {shared_secret[:8]}...")

# –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ —Ç–µ–ª–µ POST –∑–∞–ø—Ä–æ—Å–∞ —Å HTTPS
import requests
headers = {'Content-Type': 'application/json'}
requests.post(url, json={'secret': secret}, headers=headers)

# –û—á–∏—â–∞—Ç—å –ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
import gc
secret_for_use = decrypt_secret(encrypted_secret)
result = use_secret(secret_for_use)
del secret_for_use
gc.collect()
```

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û

```python
def confirm_code(code: str):
    """–ü—Ä—è–º–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    if len(code) >= 5:  # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
        # –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
        pass
```

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

```python
from typing import Tuple

def confirm_code(code: str) -> Tuple[bool, str]:
    """–ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è"""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
    if not code:
        return False, "Code is required"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    if not code.isalnum():
        return False, "Code must contain only letters and numbers"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
    if len(code) < 5 or len(code) > 10:
        return False, "Code must be 5-10 characters"
    
    # –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)
    if not validate_against_steam(code):
        return False, "Code is not valid"
    
    return True, "Code accepted"
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

#### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û

```python
def generate_code(secret: str) -> str:
    """–ë–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"""
    secret_bytes = base64.b64decode(secret)
    hmac_hash = hmac.new(secret_bytes, time_bytes, hashlib.sha1).digest()
    # ... –º–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
    return code
```

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

```python
def generate_code(secret: str) -> str:
    """–° –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        # –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å input
        if not secret:
            raise ValueError("Secret cannot be empty")
        
        # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å
        try:
            secret_bytes = base64.b64decode(secret)
        except Exception as e:
            logger.error(f"Failed to decode secret: {e}")
            raise ValueError(f"Invalid base64 secret: {e}")
        
        # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
        try:
            hmac_hash = hmac.new(secret_bytes, time_bytes, hashlib.sha1).digest()
            code = calculate_code(hmac_hash)
            return code
        except Exception as e:
            logger.error(f"Failed to generate code: {e}", exc_info=True)
            raise RuntimeError(f"Code generation failed: {e}")
            
    except ValueError as e:
        logger.warning(f"Validation error: {e}")
        return "00000"  # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    except Exception as e:
        logger.error(f"Unexpected error: {e}", exc_info=True)
        return "00000"  # Fallback
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TOTP

#### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û

```python
def test_totp():
    code = generate_code(secret)
    assert code is not None  # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

def test_totp_2():
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ
    code1 = generate_code(secret)
    time.sleep(31)
    code2 = generate_code(secret)
    assert code1 != code2
```

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û

```python
def test_totp_format():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞"""
    code = generate_code(secret)
    assert isinstance(code, str), "Code –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π"
    assert len(code) == 5, f"Code –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 5 —Å–∏–º–≤–æ–ª–æ–≤, –∞ —ç—Ç–æ {code}"
    assert code.isdigit(), f"Code –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ —Ü–∏—Ñ—Ä, –∞ —ç—Ç–æ {code}"

def test_totp_consistency():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–¥ –æ–¥–∏–Ω–∞–∫–æ–≤ –≤ –æ–¥–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ"""
    secret = base64.b64encode(os.urandom(20)).decode()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º time_offset
    code1 = generate_code(secret, time_offset=0)
    code2 = generate_code(secret, time_offset=15)  # –ß–µ—Ä–µ–∑ 15 —Å–µ–∫, –æ–¥–∏–Ω –ø–µ—Ä–∏–æ–¥
    assert code1 == code2, "–ö–æ–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã –≤ –æ–¥–Ω–æ–º 30-—Å–µ–∫ –ø–µ—Ä–∏–æ–¥–µ"

def test_totp_period_change():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–¥ –º–µ–Ω—è–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–º –ø–µ—Ä–∏–æ–¥–µ"""
    secret = base64.b64encode(os.urandom(20)).decode()
    
    code1 = generate_code(secret, time_offset=0)
    code2 = generate_code(secret, time_offset=30)  # –ù–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥
    
    # –ö–æ–¥—ã —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Ä–∞–∑–Ω—ã–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ 1/100000)
    # –ù–æ —ç—Ç–æ –¥–∞–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ —Ä–∞–±–æ—Ç–µ

def test_totp_edge_cases():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏"""
    # Secret –∏–∑ –≤—Å–µ—Ö –Ω—É–ª–µ–π
    zero_secret = base64.b64encode(bytes(20)).decode()
    code = generate_code(zero_secret)
    assert len(code) == 5 and code.isdigit()
    
    # Secret –∏–∑ –≤—Å–µ—Ö FF
    ff_secret = base64.b64encode(bytes([0xFF] * 20)).decode()
    code = generate_code(ff_secret)
    assert len(code) == 5 and code.isdigit()
```

---

## –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è Base64 –∫–æ–¥–∏—Ä–æ–≤–∫–∞

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –¥–≤–æ–π–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
secret_bytes = os.urandom(20)
secret_str = str(secret_bytes)  # –≠—Ç–æ –Ω–µ Base64!
encoded = base64.b64encode(secret_str.encode())  # –î–≤–æ–π–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
secret_bytes = os.urandom(20)
secret_b64 = base64.b64encode(secret_bytes).decode('utf-8')  # –û–¥–Ω–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### –û—à–∏–±–∫–∞ 2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–∞–π—Ç (Endianness)

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - little-endian
time_bytes = struct.pack('<Q', time_counter)  # '<' = little-endian

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - big-endian (–∫–∞–∫ –≤ Steam)
time_bytes = struct.pack('>Q', time_counter)  # '>' = big-endian
```

### –û—à–∏–±–∫–∞ 3: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π HMAC –∞–ª–≥–æ—Ä–∏—Ç–º

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - MD5
hmac_hash = hmac.new(secret_bytes, time_bytes, hashlib.md5).digest()

# ‚úì –ü–†–ê–í–ò–õ–¨–ù–û - SHA1
hmac_hash = hmac.new(secret_bytes, time_bytes, hashlib.sha1).digest()

# ‚ö†Ô∏è –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - SHA256 (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Steam)
hmac_hash = hmac.new(secret_bytes, time_bytes, hashlib.sha256).digest()
```

### –û—à–∏–±–∫–∞ 4: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è HMAC —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞–π—Ç
four_bytes = struct.unpack('>I', hmac_hash[-4:])[0]

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å
last_byte = hmac_hash[-1] & 0x0f  # –ü–æ–ª—É—á–∏—Ç—å –∏–Ω–¥–µ–∫—Å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 4 –±–∏—Ç
four_bytes = struct.unpack('>I', hmac_hash[last_byte:last_byte + 4])[0]
```

### –û—à–∏–±–∫–∞ 5: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ mafile

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –Ω–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
def load_mafile(path):
    with open(path) as f:
        return json.load(f)  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
def load_mafile(path):
    try:
        with open(path) as f:
            data = json.load(f)
        
        if not MafileValidator.validate_mafile(data):
            raise ValueError("Invalid mafile structure")
        
        return data
    except json.JSONDecodeError as e:
        raise ValueError(f"Invalid JSON: {e}")
    except FileNotFoundError:
        raise FileNotFoundError(f"Mafile not found: {path}")
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### üîê –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã

#### 1. –ó–∞—â–∏—Ç–∞ Secrets

```python
# –ù–ò–ö–û–ì–î–ê –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ secrets
‚ùå logger.info(f"Secret: {shared_secret}")
‚úì logger.info(f"Secret: {shared_secret[:8]}...{shared_secret[-4:]}")

# –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—å –≤ UI –ø–æ–ª–Ω—ã–µ secrets
‚ùå print(f"Your secret: {shared_secret}")
‚úì print(f"Secret saved safely")

# –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ GET –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
‚ùå requests.get(f"https://api.example.com?secret={secret}")
‚úì requests.post("https://api.example.com", json={"secret": secret})

# –ù–ò–ö–û–ì–î–ê –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ plaintext —Ñ–∞–π–ª–∞—Ö
‚ùå with open('secrets.txt', 'w') as f:
    f.write(shared_secret)
    
‚úì encrypted = encrypt_secret(shared_secret)
  db.save(encrypted)
```

#### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –ë—Ä—É—Ç—Ñ–æ—Ä—Å–∞

```python
from datetime import datetime, timedelta
from collections import defaultdict

class LoginRateLimiter:
    def __init__(self, max_attempts: int = 5, window_seconds: int = 300):
        self.max_attempts = max_attempts
        self.window = timedelta(seconds=window_seconds)
        self.attempts = defaultdict(list)
    
    def check_limit(self, account_name: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫"""
        now = datetime.now()
        
        # –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ø—ã—Ç–∫–∏
        self.attempts[account_name] = [
            t for t in self.attempts[account_name]
            if now - t < self.window
        ]
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç
        if len(self.attempts[account_name]) >= self.max_attempts:
            return False
        
        return True
    
    def record_attempt(self, account_name: str):
        """–ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É –≤—Ö–æ–¥–∞"""
        self.attempts[account_name].append(datetime.now())
    
    def reset(self, account_name: str):
        """–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ"""
        self.attempts[account_name] = []

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
limiter = LoginRateLimiter()

if not limiter.check_limit(account_name):
    logger.warning(f"Too many login attempts for {account_name}")
    return False, "Too many attempts, please try again later"

limiter.record_attempt(account_name)

# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
limiter.reset(account_name)
```

#### 3. –ó–∞—â–∏—Ç–∞ –º–∞files

```python
import os
from pathlib import Path

class MafileSecurityManager:
    @staticmethod
    def ensure_permissions(mafile_path: str, mode: int = 0o600):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ mafile"""
        os.chmod(mafile_path, mode)  # rw------- —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
    
    @staticmethod
    def validate_path(mafile_path: str, base_dir: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—É—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"""
        base = Path(base_dir).resolve()
        path = Path(mafile_path).resolve()
        
        # –ó–∞—â–∏—Ç–∞ –æ—Ç path traversal –∞—Ç–∞–∫
        return str(path).startswith(str(base))
    
    @staticmethod
    def backup_mafile(mafile_path: str) -> str:
        """–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é mafile"""
        import shutil
        import datetime
        
        backup_path = f"{mafile_path}.backup.{datetime.datetime.now().isoformat()}"
        shutil.copy2(mafile_path, backup_path)
        
        return backup_path

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
security = MafileSecurityManager()

# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ mafile
mafile_path = create_mafile(account_data)
security.ensure_permissions(mafile_path)

# –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if not security.validate_path(user_provided_path, MAFILES_DIR):
    raise SecurityError("Invalid mafile path")

# –ü–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
security.backup_mafile(mafile_path)
```

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ TOTP –∫–æ–¥–æ–≤

```python
from datetime import datetime, timedelta

class TOTPCache:
    def __init__(self):
        self.cache = {}  # account_name -> (code, expiry_time)
    
    def get_code(self, account_name: str, secret: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        now = datetime.now()
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
        if account_name in self.cache:
            code, expiry = self.cache[account_name]
            if now < expiry:
                return code
        
        # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥
        code = generate_totp(secret)
        
        # –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –¥–æ —Å–º–µ–Ω—ã
        seconds_until_change = 30 - (int(time.time()) % 30)
        expiry = now + timedelta(seconds=seconds_until_change)
        
        self.cache[account_name] = (code, expiry)
        
        return code

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
cache = TOTPCache()
code = cache.get_code("myaccount", shared_secret)
# –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫ –≤–µ—Ä–Ω–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
```

### 2. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

class AsyncSteamGuard:
    def __init__(self):
        self.executor = ThreadPoolExecutor(max_workers=4)
    
    async def generate_code_async(self, secret: str) -> str:
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"""
        loop = asyncio.get_event_loop()
        return await loop.run_in_executor(
            self.executor,
            generate_totp,
            secret
        )
    
    async def batch_generate_codes(self, accounts: list) -> dict:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥—ã –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"""
        tasks = [
            self.generate_code_async(acc['shared_secret'])
            for acc in accounts
        ]
        
        codes = await asyncio.gather(*tasks)
        
        return {
            acc['account_name']: code
            for acc, code in zip(accounts, codes)
        }

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
guard = AsyncSteamGuard()
codes = await guard.batch_generate_codes(accounts)
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Mafile](MAFILE_STRUCTURE_GUIDE.md)
- [–ü—Ä–∏–º–µ—Ä—ã –∏ –¢–µ—Å—Ç—ã](MAFILE_EXAMPLES_AND_TESTS.md)
- [Steam Guard –Ω–∞ GitHub](https://github.com/search?q=steamguard+mafile)

